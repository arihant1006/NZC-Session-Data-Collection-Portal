{% extends "base.html" %}

{% block title %}Record Session - NZC Activator{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm border p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">Record New Session</h1>
        
        <form id="session-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="school_name" class="block text-sm font-medium text-gray-700 mb-2">School/College Name *</label>
                    <input type="text" id="school_name" name="school_name" required list="school-suggestions"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Type or select a school/college">
                    <datalist id="school-suggestions">
                        <option value="University of Auckland">
                        <option value="University of Otago">
                        <option value="University of Canterbury">
                        <option value="Victoria University of Wellington">
                        <option value="University of Waikato">
                        <option value="Massey University">
                        <option value="Lincoln University">
                        <option value="Auckland University of Technology">
                        <option value="Auckland Grammar School">
                        <option value="Epsom Girls Grammar School">
                        <option value="St Cuthbert's College">
                        <option value="King's College">
                        <option value="Mount Albert Grammar School">
                        <option value="Wellington College">
                        <option value="Wellington Girls' College">
                        <option value="Scots College">
                        <option value="Samuel Marsden Collegiate School">
                        <option value="Christchurch Boys' High School">
                        <option value="Christchurch Girls' High School">
                        <option value="St Andrew's College">
                        <option value="Rangi Ruru Girls' School">
                        <option value="Otago Boys' High School">
                        <option value="Otago Girls' High School">
                        <option value="John McGlashan College">
                    </datalist>
                </div>
                
                <div>
                    <label for="session_type" class="block text-sm font-medium text-gray-700 mb-2">Session Type *</label>
                    <input type="text" id="session_type" name="session_type" required list="session-type-suggestions"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Type or select session type">
                    <datalist id="session-type-suggestions">
                        <option value="School Festive Day">
                        <option value="Community Hub Practice">
                        <option value="Girl's Cricket Programme">
                        <option value="Kiwi Cricket Skills Session">
                        <option value="In2Cricket Taster">
                        <option value="Other">
                    </datalist>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Location *</label>
                    <input type="text" id="location" name="location" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="activator" class="block text-sm font-medium text-gray-700 mb-2">Activator *</label>
                    <input type="text" id="activator" name="activator" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="year_group" class="block text-sm font-medium text-gray-700 mb-2">Year Group *</label>
                    <select id="year_group" name="year_group" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select year group</option>
                        <option value="Year 3-4">Year 3-4</option>
                        <option value="Year 5-6">Year 5-6</option>
                        <option value="Year 7-8">Year 7-8</option>
                        <option value="Year 9-10">Year 9-10</option>
                        <option value="Year 11-13">Year 11-13</option>
                        <option value="Mixed">Mixed</option>
                    </select>
                </div>
                
                <div>
                    <label for="session_date" class="block text-sm font-medium text-gray-700 mb-2">Session Date *</label>
                    <input type="date" id="session_date" name="session_date" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="male_participants" class="block text-sm font-medium text-gray-700 mb-2">Male Participants *</label>
                    <input type="number" id="male_participants" name="male_participants" min="0" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="female_participants" class="block text-sm font-medium text-gray-700 mb-2">Female Participants *</label>
                    <input type="number" id="female_participants" name="female_participants" min="0" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>

            <div>
                <label for="session_duration" class="block text-sm font-medium text-gray-700 mb-2">Session Duration (minutes) *</label>
                <input type="number" id="session_duration" name="session_duration" min="0" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label for="teacher_feedback" class="block text-sm font-medium text-gray-700 mb-2">Teacher/Coach Feedback</label>
                <textarea id="teacher_feedback" name="teacher_feedback" rows="4"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Optional feedback from teachers..."></textarea>
            </div>
            
            <!-- Geolocation Section -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Location Services</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="latitude" class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., -36.8485">
                    </div>
                    <div>
                        <label for="longitude" class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., 174.7633">
                    </div>
                </div>
                <button type="button" id="get-location" 
                        class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    Get Current Location
                </button>
                <p id="location-status" class="text-sm text-gray-600 mt-2"></p>
            </div>
            
            <!-- Photo Upload Section -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Photo Upload</h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <i class="fas fa-camera text-gray-400 text-3xl mb-4"></i>
                    <p class="text-gray-600 mb-2">Upload session photos (Max 5MB each)</p>
                    <input type="file" id="photo-upload" accept="image/*" multiple class="hidden">
                    <button type="button" onclick="document.getElementById('photo-upload').click()"
                            class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-upload mr-2"></i>
                        Choose Photos
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Supported formats: PNG, JPG, JPEG, GIF</p>
                </div>
                <div id="photo-preview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6">
                <a href="/" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                    Record Session
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let selectedFiles = [];

// Set current date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('session_date').value = today;
    
    // Add real-time validation to all form fields
    setupRealTimeValidation();
});

function setupRealTimeValidation() {
    // School name validation - only letters, spaces, hyphens, periods, apostrophes, numbers
    document.getElementById('school_name').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove invalid characters
        value = value.replace(/[^a-zA-Z0-9\s\-\.'&]/g, '');
        // Limit length
        if (value.length > 100) {
            value = value.substring(0, 100);
        }
        e.target.value = value;
        validateTextField(this, 'School name', 2, 100);
    });

    // Session type validation - only letters, spaces, hyphens, periods, apostrophes
    document.getElementById('session_type').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove invalid characters
        value = value.replace(/[^a-zA-Z\s\-\.']/g, '');
        // Limit length
        if (value.length > 50) {
            value = value.substring(0, 50);
        }
        e.target.value = value;
        validateTextField(this, 'Session type', 2, 50);
    });

    // Location validation - letters, numbers, spaces, common punctuation
    document.getElementById('location').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove invalid characters
        value = value.replace(/[^a-zA-Z0-9\s\-\.,'/&()]/g, '');
        // Limit length
        if (value.length > 100) {
            value = value.substring(0, 100);
        }
        e.target.value = value;
        validateTextField(this, 'Location', 2, 100);
    });

    // Activator validation - only letters, spaces, hyphens, periods
    document.getElementById('activator').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove invalid characters (only letters, spaces, hyphens, periods)
        value = value.replace(/[^a-zA-Z\s\-\.]/g, '');
        // Limit length
        if (value.length > 50) {
            value = value.substring(0, 50);
        }
        e.target.value = value;
        validateActivatorField(this);
    });

    // Male participants validation - only positive integers
    document.getElementById('male_participants').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove non-numeric characters
        value = value.replace(/[^0-9]/g, '');
        // Convert to number and limit
        if (value !== '') {
            let num = parseInt(value);
            if (num > 1000) {
                value = '1000';
            }
        }
        e.target.value = value;
        validateParticipantsField(this, 'Male participants');
    });

    // Female participants validation - only positive integers
    document.getElementById('female_participants').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove non-numeric characters
        value = value.replace(/[^0-9]/g, '');
        // Convert to number and limit
        if (value !== '') {
            let num = parseInt(value);
            if (num > 1000) {
                value = '1000';
            }
        }
        e.target.value = value;
        validateParticipantsField(this, 'Female participants');
    });

    // Session duration validation - only positive integers
    document.getElementById('session_duration').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove non-numeric characters
        value = value.replace(/[^0-9]/g, '');
        // Convert to number and limit (max 8 hours = 480 minutes)
        if (value !== '') {
            let num = parseInt(value);
            if (num > 480) {
                value = '480';
            }
        }
        e.target.value = value;
        validateDurationField(this);
    });

    // Latitude validation - decimal numbers between -90 and 90
    document.getElementById('latitude').addEventListener('input', function(e) {
        let value = e.target.value;
        // Allow only numbers, decimal point, and minus sign
        value = value.replace(/[^0-9\.\-]/g, '');
        
        // Ensure only one decimal point
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Ensure minus sign only at the beginning
        if (value.indexOf('-') > 0) {
            value = value.replace(/-/g, '');
            if (e.target.value.startsWith('-')) {
                value = '-' + value;
            }
        }
        
        // Validate range
        if (value !== '' && value !== '-') {
            let num = parseFloat(value);
            if (!isNaN(num)) {
                if (num > 90) {
                    value = '90';
                } else if (num < -90) {
                    value = '-90';
                }
            }
        }
        
        e.target.value = value;
        validateCoordinateField(this, 'Latitude', -90, 90);
    });

    // Longitude validation - decimal numbers between -180 and 180
    document.getElementById('longitude').addEventListener('input', function(e) {
        let value = e.target.value;
        // Allow only numbers, decimal point, and minus sign
        value = value.replace(/[^0-9\.\-]/g, '');
        
        // Ensure only one decimal point
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Ensure minus sign only at the beginning
        if (value.indexOf('-') > 0) {
            value = value.replace(/-/g, '');
            if (e.target.value.startsWith('-')) {
                value = '-' + value;
            }
        }
        
        // Validate range
        if (value !== '' && value !== '-') {
            let num = parseFloat(value);
            if (!isNaN(num)) {
                if (num > 180) {
                    value = '180';
                } else if (num < -180) {
                    value = '-180';
                }
            }
        }
        
        e.target.value = value;
        validateCoordinateField(this, 'Longitude', -180, 180);
    });

    // Teacher feedback validation - limit length
    document.getElementById('teacher_feedback').addEventListener('input', function(e) {
        let value = e.target.value;
        // Limit length to 1000 characters
        if (value.length > 1000) {
            value = value.substring(0, 1000);
            e.target.value = value;
            showFieldError(this, 'Teacher feedback must be less than 1000 characters');
        } else {
            clearFieldError(this);
        }
    });

    // Session date validation - prevent future dates
    document.getElementById('session_date').addEventListener('change', function(e) {
        const selectedDate = new Date(e.target.value);
        const today = new Date();
        today.setHours(23, 59, 59, 999);
        
        if (selectedDate > today) {
            // Reset to today's date
            e.target.value = new Date().toISOString().split('T')[0];
            showFieldError(this, 'Session date cannot be in the future');
        } else if (selectedDate < new Date('2020-01-01')) {
            // Reset to minimum date
            e.target.value = '2020-01-01';
            showFieldError(this, 'Session date seems too old');
        } else {
            clearFieldError(this);
        }
    });

    // Prevent paste of invalid content
    document.querySelectorAll('input[type="text"], textarea').forEach(input => {
        input.addEventListener('paste', function(e) {
            setTimeout(() => {
                // Trigger input event to validate pasted content
                this.dispatchEvent(new Event('input', { bubbles: true }));
            }, 0);
        });
    });

    // Prevent invalid key presses for numeric fields
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true)) {
                return;
            }
            
            // For latitude/longitude, allow decimal point and minus
            if (input.id === 'latitude' || input.id === 'longitude') {
                if (e.key === '.' && input.value.indexOf('.') === -1) {
                    return;
                }
                if (e.key === '-' && input.value.indexOf('-') === -1 && input.selectionStart === 0) {
                    return;
                }
            }
            
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
    });
}

// Enhanced form validation and submission with offline support
document.getElementById('session-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous error messages
    clearErrorMessages();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Final validation before submission
    const validationErrors = validateFormData(data);
    if (validationErrors.length > 0) {
        displayErrorMessages(validationErrors);
        return;
    }
    
    // Show loading state
    const submitButton = document.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = 'Recording...';
    submitButton.disabled = true;
    
    try {
        // First, try online submission if we're online
        if (navigator.onLine) {
            try {
                console.log('Attempting online submission...');
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('Online submission successful');
                    
                    // If photos are selected, upload them
                    if (selectedFiles.length > 0) {
                        submitButton.textContent = 'Uploading photos...';
                        try {
                            await uploadPhotos(result.session_id);
                        } catch (photoError) {
                            console.warn('Photo upload failed:', photoError);
                            // Continue anyway - session was saved
                        }
                    }
                    
                    window.location.href = '/success';
                    return;
                } else {
                    console.log('Online submission failed:', result.errors);
                    throw new Error(result.errors?.join(', ') || 'Server error');
                }
            } catch (onlineError) {
                console.log('Online submission failed, trying offline:', onlineError.message);
                // Continue to offline storage
            }
        } else {
            console.log('Offline detected, using offline storage');
        }
        
        // Try offline storage
        console.log('Attempting offline storage...');
        
        // Wait for offline sync to be ready
        const offlineReady = await waitForOfflineSync(3000);
        
        if (offlineReady && window.offlineSyncManager) {
            try {
                submitButton.textContent = 'Saving offline...';
                console.log('Saving session offline...');
                
                await window.offlineSyncManager.saveSessionOffline(data, selectedFiles);
                console.log('Session saved offline successfully');
                
                // Show offline success message
                showOfflineSuccessMessage();
                return;
                
            } catch (offlineError) {
                console.error('Offline storage failed:', offlineError);
                throw new Error('Failed to save session offline: ' + offlineError.message);
            }
        } else {
            console.error('Offline sync not available');
            throw new Error('Offline storage is not available. Please check your connection and try again.');
        }
        
    } catch (error) {
        console.error('Final error:', error);
        displayErrorMessages([error.message || 'Unable to save session. Please check your connection and try again.']);
    } finally {
        // Reset button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    }
});

function showOfflineSuccessMessage() {
    // Create offline success modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <div class="text-center">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-wifi-slash text-orange-500 text-2xl"></i>
                </div>
                
                <h2 class="text-xl font-bold text-gray-900 mb-2">Session Saved Offline</h2>
                <p class="text-gray-600 mb-6">Your session has been saved locally and will be synced when you're back online.</p>
                
                <div class="space-y-3">
                    <button onclick="window.location.href='/record'" 
                           class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                        Record Another Session
                    </button>
                    <button onclick="window.location.href='/'" 
                           class="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        Back to Home
                    </button>
                    <button onclick="window.location.href='/sessions'" 
                           class="w-full px-4 py-2 text-blue-500 hover:text-blue-600 transition-colors">
                        View All Sessions
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Remove modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}

async function uploadPhotos(sessionId) {
    if (selectedFiles.length === 0) return;
    
    const formData = new FormData();
    selectedFiles.forEach(file => {
        formData.append('photos', file);
    });
    
    try {
        const response = await fetch(`/api/sessions/${sessionId}/photos`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (!result.success) {
            console.error('Photo upload failed:', result.errors);
        }
    } catch (error) {
        console.error('Photo upload error:', error);
    }
}

function validateFormData(data) {
    const errors = [];
    
    // Required fields validation
    if (!data.school_name || data.school_name.trim().length < 2) {
        errors.push('School name must be at least 2 characters long');
    }
    if (data.school_name && data.school_name.trim().length > 100) {
        errors.push('School name must be less than 100 characters');
    }
    
    if (!data.session_type || data.session_type.trim().length < 2) {
        errors.push('Session type must be at least 2 characters long');
    }
    if (data.session_type && data.session_type.trim().length > 50) {
        errors.push('Session type must be less than 50 characters');
    }
    
    if (!data.location || data.location.trim().length < 2) {
        errors.push('Location must be at least 2 characters long');
    }
    if (data.location && data.location.trim().length > 100) {
        errors.push('Location must be less than 100 characters');
    }
    
    if (!data.activator || data.activator.trim().length < 2) {
        errors.push('Activator name must be at least 2 characters long');
    }
    if (data.activator && data.activator.trim().length > 50) {
        errors.push('Activator name must be less than 50 characters');
    }
    if (data.activator && !/^[a-zA-Z\s\-\.]+$/.test(data.activator.trim())) {
        errors.push('Activator name can only contain letters, spaces, hyphens, and periods');
    }
    
    if (!data.year_group) {
        errors.push('Please select a year group');
    }
    
    // Participants validation
    const maleParticipants = parseInt(data.male_participants);
    const femaleParticipants = parseInt(data.female_participants);
    
    if (isNaN(maleParticipants) || maleParticipants < 0) {
        errors.push('Male participants must be a valid number (0 or greater)');
    }
    if (maleParticipants > 1000) {
        errors.push('Male participants seems too high (max 1000)');
    }
    
    if (isNaN(femaleParticipants) || femaleParticipants < 0) {
        errors.push('Female participants must be a valid number (0 or greater)');
    }
    if (femaleParticipants > 1000) {
        errors.push('Female participants seems too high (max 1000)');
    }
    
    if (maleParticipants + femaleParticipants === 0) {
        errors.push('Total participants must be greater than 0');
    }
    if (maleParticipants + femaleParticipants > 2000) {
        errors.push('Total participants seems too high (max 2000)');
    }
    
    // Session duration validation
    const duration = parseInt(data.session_duration);
    if (isNaN(duration) || duration <= 0) {
        errors.push('Session duration must be greater than 0 minutes');
    }
    if (duration > 480) {
        errors.push('Session duration seems too long (max 8 hours)');
    }
    
    // Date validation
    if (!data.session_date) {
        errors.push('Session date is required');
    } else {
        const sessionDate = new Date(data.session_date);
        const today = new Date();
        today.setHours(23, 59, 59, 999); // End of today
        
        if (sessionDate > today) {
            errors.push('Session date cannot be in the future');
        }
        if (sessionDate < new Date('2020-01-01')) {
            errors.push('Session date seems too old');
        }
    }
    
    // Coordinates validation (optional)
    if (data.latitude && data.latitude.trim() !== '') {
        const lat = parseFloat(data.latitude);
        if (isNaN(lat) || lat < -90 || lat > 90) {
            errors.push('Latitude must be a valid number between -90 and 90');
        }
    }
    
    if (data.longitude && data.longitude.trim() !== '') {
        const lng = parseFloat(data.longitude);
        if (isNaN(lng) || lng < -180 || lng > 180) {
            errors.push('Longitude must be a valid number between -180 and 180');
        }
    }
    
    // Teacher feedback validation (optional)
    if (data.teacher_feedback && data.teacher_feedback.length > 1000) {
        errors.push('Teacher feedback must be less than 1000 characters');
    }
    
    return errors;
}

function displayErrorMessages(errors) {
    // Remove existing error container
    const existingErrorContainer = document.getElementById('error-container');
    if (existingErrorContainer) {
        existingErrorContainer.remove();
    }
    
    // Create error container
    const errorContainer = document.createElement('div');
    errorContainer.id = 'error-container';
    errorContainer.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-md';
    
    const errorTitle = document.createElement('h3');
    errorTitle.className = 'text-sm font-medium text-red-800 mb-2';
    errorTitle.textContent = 'Please fix the following errors:';
    
    const errorList = document.createElement('ul');
    errorList.className = 'text-sm text-red-700 space-y-1';
    
    errors.forEach(error => {
        const listItem = document.createElement('li');
        listItem.className = 'flex items-center';
        listItem.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${error}`;
        errorList.appendChild(listItem);
    });
    
    errorContainer.appendChild(errorTitle);
    errorContainer.appendChild(errorList);
    
    // Insert error container at the top of the form
    const form = document.getElementById('session-form');
    form.insertBefore(errorContainer, form.firstChild);
    
    // Scroll to top of form
    errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function clearErrorMessages() {
    const errorContainer = document.getElementById('error-container');
    if (errorContainer) {
        errorContainer.remove();
    }
}

function validateTextField(field, fieldName, minLength, maxLength) {
    const value = field.value.trim();
    clearFieldError(field);
    
    if (field.required && value.length < minLength) {
        showFieldError(field, `${fieldName} must be at least ${minLength} characters long`);
        return false;
    }
    if (value.length > maxLength) {
        showFieldError(field, `${fieldName} must be less than ${maxLength} characters`);
        return false;
    }
    return true;
}

function validateActivatorField(field) {
    const value = field.value.trim();
    clearFieldError(field);
    
    if (field.required && value.length < 2) {
        showFieldError(field, 'Activator name must be at least 2 characters long');
        return false;
    }
    if (value.length > 50) {
        showFieldError(field, 'Activator name must be less than 50 characters');
        return false;
    }
    if (value && !/^[a-zA-Z\s\-\.]+$/.test(value)) {
        showFieldError(field, 'Activator name can only contain letters, spaces, hyphens, and periods');
        return false;
    }
    return true;
}

function validateParticipantsField(field, fieldName) {
    const value = parseInt(field.value);
    clearFieldError(field);
    
    if (isNaN(value) || value < 0) {
        showFieldError(field, `${fieldName} must be 0 or greater`);
        return false;
    }
    if (value > 1000) {
        showFieldError(field, `${fieldName} seems too high (max 1000)`);
        return false;
    }
    return true;
}

function validateDurationField(field) {
    const value = parseInt(field.value);
    clearFieldError(field);
    
    if (isNaN(value) || value <= 0) {
        showFieldError(field, 'Session duration must be greater than 0 minutes');
        return false;
    }
    if (value > 480) {
        showFieldError(field, 'Session duration seems too long (max 8 hours)');
        return false;
    }
    return true;
}

function validateCoordinateField(field, fieldName, min, max) {
    const value = field.value.trim();
    clearFieldError(field);
    
    if (value === '') return true; // Optional field
    
    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < min || numValue > max) {
        showFieldError(field, `${fieldName} must be a valid number between ${min} and ${max}`);
        return false;
    }
    return true;
}

function showFieldError(field, message) {
    field.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
    field.classList.remove('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
    
    // Create error message element
    const errorElement = document.createElement('p');
    errorElement.className = 'text-red-600 text-sm mt-1 field-error';
    errorElement.textContent = message;
    
    // Insert after the field
    field.parentNode.insertBefore(errorElement, field.nextSibling);
}

function clearFieldError(field) {
    field.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
    field.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
    
    // Remove error message
    const errorElement = field.parentNode.querySelector('.field-error');
    if (errorElement) {
        errorElement.remove();
    }
}

// Geolocation
document.getElementById('get-location').addEventListener('click', function() {
    const statusElement = document.getElementById('location-status');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    
    if (navigator.geolocation) {
        statusElement.textContent = 'Getting location...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                statusElement.textContent = `Location captured: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                statusElement.className = 'text-sm text-green-600 mt-2';
                latitudeInput.value = lat;
                longitudeInput.value = lng;
            },
            function(error) {
                statusElement.textContent = 'Unable to get location. Please check your browser settings.';
                statusElement.className = 'text-sm text-red-600 mt-2';
            }
        );
    } else {
        statusElement.textContent = 'Geolocation is not supported by this browser.';
        statusElement.className = 'text-sm text-red-600 mt-2';
    }
});

// Enhanced photo upload with validation
document.getElementById('photo-upload').addEventListener('change', function(e) {
    const previewContainer = document.getElementById('photo-preview');
    const files = Array.from(e.target.files);
    
    // Clear previous selections
    selectedFiles = [];
    previewContainer.innerHTML = '';
    
    files.forEach((file, index) => {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert(`File "${file.name}" is not an image and will be skipped.`);
            return;
        }
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert(`File "${file.name}" is too large (max 5MB) and will be skipped.`);
            return;
        }
        
        selectedFiles.push(file);
        
        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'relative';
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'w-full h-24 object-cover rounded-lg';
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = function() {
                // Remove from selectedFiles array
                const fileIndex = selectedFiles.indexOf(file);
                if (fileIndex > -1) {
                    selectedFiles.splice(fileIndex, 1);
                }
                // Remove preview
                previewDiv.remove();
            };
            
            const fileName = document.createElement('p');
            fileName.className = 'text-xs text-gray-600 mt-1 truncate';
            fileName.textContent = file.name;
            
            previewDiv.appendChild(img);
            previewDiv.appendChild(removeBtn);
            previewDiv.appendChild(fileName);
            previewContainer.appendChild(previewDiv);
        };
        reader.readAsDataURL(file);
    });
});

async function waitForOfflineSync(timeout) {
    return new Promise((resolve) => {
        if (window.offlineSyncManager && typeof window.offlineSyncManager.isReady === 'function') {
            const checkInterval = setInterval(() => {
                if (window.offlineSyncManager.isReady()) {
                    clearInterval(checkInterval);
                    clearTimeout(timeoutId);
                    resolve(true);
                }
            }, 100);

            const timeoutId = setTimeout(() => {
                clearInterval(checkInterval);
                resolve(false);
            }, timeout);
        } else {
            resolve(false);
        }
    });
}
</script>
{% endblock %}
